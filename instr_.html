<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>sky_instruments beta</title>
</head>
<body>
	<script src="style.js" async></script>
	<script>Object.assign(new Image(),{onerror:()=>document.body.classList.add('nowebp'),src:'img/tex.webp'});</script>
	<style>
		:root{--size:80px;--bp:0 0;user-select:none;-webkit-user-select:none;touch-action:manipulation;}
		html,body{height:100%;margin:0;position:relative;overflow:hidden;}
		#c{display:block;margin:0 auto;width:100%;max-height:auto;touch-action:none;opacity:.5;transition:opacity .2s;}

		#menu input,body>input{display:none;}
		.grid{display:inline-block;width:var(--size);height:var(--size);margin:0;vertical-align:top;position:relative;overflow:hidden;touch-action:manipulation;}
		.grid::before,.grid::after,.grid *{content:"";display:block;width:78.4%;height:78.4%;position:absolute;margin:10.8%;border-radius:17%;}
		.grid::before{background:var(--bp)/800% #3338 url(img/instr.svg);}.grid::after{content:none;}
		.grid.tex::before{background-image:url(img/tex.webp);}.nowebp .grid.tex::before{background-image:url(img/tex.png);}
		:checked+.grid::after,.grid.a::after{content:"";box-sizing:border-box;border:calc(var(--size)*.13328) solid #00000001;border-image:url(img/sel.svg) 33.333%;}:checked+.grid,.grid.a{transform:rotateY(360deg);transition:.5s;}
		:disabled+.grid,.grid.d,.d .grid{filter:grayscale(1)opacity(.7);pointer-events:none;}
		.btn:active{transform:scale(.85);}.btn:not(:active){transition:.2s;}
		.clock::before{--bp:-200% -0%;filter:saturate(.3);}.clock::after{content:"";transition:.2s;transform:rotate(var(--rot,45deg));filter:drop-shadow(0 0 2px #aef);background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 18 18'%3E%3Cpath d='M6 6h1v1h-1z' fill='%23caf0f6'/%3E%3C/svg%3E");}
		.clock.d::after,.d .clock::after{--rot:initial;}

		#mico{position:fixed;right:0;bottom:0;--size:48px;}#mico::before{transition:transform .5s;}#drwcb:checked~#mico::before{transform:rotateY(360deg);background-image:url(img/instr.svg);--bp:-400% 0;}
		#drawer{width:calc(var(--size)*3.3);height:100%;padding-bottom:56px;box-sizing:border-box;text-align:center;position:absolute;top:0;right:0;overflow-y:auto;background-color:#3338;transform:translateX(100%);visibility:hidden;transition:.2s;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);}
		#drawer hr{border:0;}#drawer hr::before{content:"";display:block;margin:0 auto;width:4px;height:4px;background:#8888;border-radius:50%;}
		#drwcb:checked~#drawer{transform:translateX(0);visibility:unset;}

		label[for=alcb],#albox{position:fixed;pointer-events:none;visibility:hidden;opacity:0;background-color:#0008;transition:.2s;}
		label[for=alcb]{top:0;left:0;width:100%;height:100%;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);}
		#albox{top:50%;left:50%;max-width:calc(100% - 64px);max-height:calc(100% - 64px);padding:16px;margin:0;border-radius:16px;box-sizing:border-box;transform:translate(-50%,-50%);white-space:pre-wrap;overflow:auto;overflow-x:hidden;}
		#alcb:checked~label[for=alcb],#alcb:checked~#albox{pointer-events:auto;visibility:visible;opacity:1;}
	</style>
	<input type="checkbox" id="drwcb">
	<input type="checkbox" id="alcb">
	<canvas id="c"></canvas>
	<div id="drawer">
		<form id="menu"></form>
		<hr>
		<div id="scd">
			<p class="grid btn" style="--bp:-600% -0%;">
			</p><p class="grid btn clock">
			</p><p class="grid btn" style="--bp:-500% -0%;"></p>
		</div>
		<hr>
		<p class="grid btn tex" style="--bp:-100% 0;" id="stgbtn">
		</p><p id="recbtn" class="grid btn d" style="--bp:0 -100%;">
		</p><a class="grid btn" style="--bp:-100% -100%;" href="manual/index.html?m=instr" target="_blank">
		</a><p class="grid btn tex" id="infobtn">
		</p>
	</div>
	<label for="drwcb" id="mico" class="grid tex"></label>
	<label for="alcb"></label><pre id="albox" class="style"></pre>

	<script>
		'use strict';
		const texts=Object.assign({
				info:'<h1>sky_instruments</h1><hr><h2>Audio</h2><h3>Piano</h3>Tone.js Salamander\n<small>cc-by Alexander Holm</small><h3>Others</h3>In game sounds\n<small>recorded by @McbeEringi</small><hr><p>[sky_instr] v5 build:2201260\n<a href="https://twitter.com/mcbeeringi">@McbeEringi</a> MITLicense</p>',
				rev:'reverb',delay:'delay',kbs:'key size',
				amb:'ambient',ambl:['none','hotspring','home','forest','vault'],
				ci:'custom instruments',loading:'loading…',default:'default',cnew:'create new…',note:'note',cin:'instr name',fsel:'choose file',
			},{
				ja:{
					rev:'リバーブ',delay:'遅延',kbs:'キーのサイズ',
					amb:'環境音',ambl:['なし','温泉','ホーム','雨林','書庫'],
					ci:'楽器のカスタム',loading:'読み込み中…',default:'デフォルト',cnew:'新規作成…',note:'音名',cin:'楽器名',fsel:'ファイルを選択',
				}
			}[navigator.language.slice(0,2)]),
			n2nn=x=>({c:12,d:14,e:16,f:17,g:19,a:21,b:23})[x[0].toLowerCase()]+(({'#':1,s:1})[x[1]]?x.slice(2)*12+1:x.slice(1)*12),
			bp=i=>`${i%8*-100}% ${Math.floor(i*.125+1)*-100}%`,
			stdli=(a,b=a+1,s={})=>{for(let i=a;i<=b;i++){s['ds'+i]=`ds${i}.mp3`;s['a'+i]=`a${i}.mp3`;}return s;},
			d={
				instr:[
					['audio/instr/musicbox/',1,[stdli(4,6,{a3:'a3.mp3',ds7:'ds7.mp3'})],0],
					['audio/instr/harp/',-1,[stdli(3,5)],0],//210503
					['audio/instr/percussion/',0,[{a4:'0.mp3',as4:'1.mp3',b4:'2.mp3',c5:'3.mp3',a5:'4.mp3',as5:'5.mp3',b5:'6.mp3',c6:'7.mp3'}],1],
					['audio/instr/contrabass/',-2,[stdli(2,4)],0],//211009
					['audio/instr/horn/',-1,[stdli(3,5)],0],//211009
						['audio/instr/piano/',0,[stdli(4)],0],
						['',0,[{ds5:'audio/instr/musicbox/ds6.mp3',a5:'audio/instr/musicbox/a6.mp3'},{ds5:'audio/instr/glock/ds5.mp3',a5:'audio/instr/glock/a5.mp3'}],2],
						['audio/instr/bell2/',1,[{c4:'c4.mp3',d4:'d4.mp3',g4:'g4.mp3',a4:'a4.mp3'},{c4:'c4_.mp3',d4:'d4_.mp3',g4:'g4_.mp3',a4:'a4_.mp3'}],2],
					['audio/instr/flute/',0,[stdli(4,6)],0],//211009
					['audio/instr/quena/',0,[stdli(4,6)],0],//211009
					['audio/instr/guitar/',-1,[stdli(3,5)],0,4],//main:210503 fret:211009
					['audio/instr/ukulele/',-1,[stdli(3,5)],0],//211009
						['audio/instr/piano/',1,[stdli(5)],0],
					['audio/instr/glock/',0,[stdli(4,6)],0],//210529
					['audio/instr/handpan/',-1,[stdli(3)],3],
					['audio/instr/dundun/',0,[{a4:'0.mp3',as4:'1.mp3',b4:'2.mp3',c5:'3.mp3',a5:'4.mp3',as5:'5.mp3',b5:'6.mp3',c6:'7.mp3'}],1],
					['audio/instr/pipa/',-1,[stdli(3,5)],0],//210529
					['audio/instr/bugle/',0,[stdli(4,6)],0],//210529
						['audio/instr/ocarina/',0,[stdli(4,6)],0],
					['audio/instr/kalimba/',0,[stdli(4,6)],0]//211025
				],
				i2n:[
					[-9,-7,-5,-4,-2,0,2,3,5,7,8,10,12,14,15],
					[0,1,2,3,12,13,14,15],//percussion
					[-9,-7,-2,0,-9,-7,-2,0],//bell
					[-7,0,3,5,8,10,12,15],//handpan
					[2,5,12,-10,-7,0,-22,-19,-12]//nov
				],
				g:[0,1,1,1,2],
				k2g:[
					[5,3],
					[4,2],
					[3,3]
				],
				p:[0,0,1,0,0],
				i2p:[[],
					[0,0,0,0,1,1,1,1]
				]
			},
			cfg={
				frame:24,tex:new Image(),
				k2i:Object.fromEntries(Array.from('QWERTASDFGZXCVB',(x,i)=>[`Key${x}`,[i%5,Math.floor(i/5)]]))
			},
			ctx=c.getContext('2d'),
			actx=new(window.AudioContext||webkitAudioContext)(),
			revn=actx.createConvolver(),gn0=actx.createGain(),gn1=actx.createGain(),
			deln=actx.createDelay(1),
			cset=()=>{
				Object.assign(c.style,{maxWidth:cfg.kbs*cfg.grid[0]+'px',maxHeight:cfg.kbs*cfg.grid[1]+'px',marginTop:`min(${cfg.kbs/2}px,${50/cfg.grid[0]}%)`});
				c.width=Math.min(c.parentNode.clientWidth,cfg.kbs*cfg.grid[0])*devicePixelRatio;cfg.size=c.width/cfg.grid[0];c.height=cfg.size*cfg.grid[1];
				draw(true);
			},
			set=(i=+menu.instr.value)=>{
				c.style.opacity='';
				Object.assign(cfg,{
					url:d.instr[i][0],
					octave:d.instr[i][1]*12,
					n:d.instr[i][2],
					i2n:d.i2n[d.instr[i][3]],
					i2p:d.i2p[d.p[d.instr[i][3]]],
					gflag:new Array(d.i2n[d.instr[i][3]].length).fill(0),
					grid:d.k2g[d.g[d.instr[i][3]]],
					c:d.g[d.instr[i][3]]==0,
					scf:d.instr[i][3]!=1
				});
				mico.setAttribute('style',`--bp:${bp(i)};`);
				cset();
				if(!cfg.scf)scd.classList.add('d');else scd.classList.remove('d');
				Promise.all(cfg.n.map(x=>
					Promise.all(Object.entries(x).map(async y=>{
						y[1]=await(await fetch(cfg.url+y[1])).arrayBuffer();
						y[1]=await new Promise((f,r)=>actx.decodeAudioData(y[1],f,r));
						y[0]=n2nn(y[0]);
						return y;
					}))
				)).then(x=>{cfg.abuff=x;c.style.opacity=1;});
			},
			fire=e=>{
				if(!cfg.abuff)return;
				e.preventDefault();
				const bcr=c.getBoundingClientRect();
				(e.changedTouches?[...e.changedTouches]:[e]).forEach(x=>{
					const p=x.p||[(x.clientX-bcr.x)/bcr.width*cfg.grid[0],(x.clientY-bcr.y)/bcr.height*cfg.grid[1]],
						i=Math.floor(p[0])+Math.floor(p[1])*cfg.grid[0],
						trg=!cfg.gflag.some(x=>x);
					trigger(69+cfg.i2n[i]+cfg.octave+cfg.sc*cfg.scf,cfg.i2p[i]);
					cfg.gflag[i]=cfg.frame;
					if(trg)draw();
				});
			},
			draw=all=>{
				const mix=(x,y,a)=>x*(1-a)+y*a,
					r=12*devicePixelRatio,a=cfg.size*.784,ar=a-r-r,ah=a/2,
					rs=(x=0,y=0,c=1,s=1)=>{
						const rs=r*s,as=a*s,ars=ar*s,arc=ars*c,rc=rs*c,sign=+(Math.sign(c)<0);
						return new Path2D(`M${x} ${y}m${-arc/2-rc} ${-ars/2}
							v${ ars}a${rc} ${rs} 0 0 ${sign} ${ rc} ${ rs}h${ arc}a${rc} ${rs} 0 0 ${sign} ${ rc} ${-rs}
							v${-ars}a${rc} ${rs} 0 0 ${sign} ${-rc} ${-rs}h${-arc}a${rc} ${rs} 0 0 ${sign} ${-rc} ${ rs}
						`);
					};
				ctx.fillStyle='#3338';
				cfg.gflag=cfg.gflag.map((x,i)=>{
					if(all||x){
						x=Math.max(x-1,0);
						i=[i%cfg.grid[0],Math.floor(i/cfg.grid[0])];
						const p=i.map(y=>(y+.5)*cfg.size),c=Math.cos(x/cfg.frame*2*Math.PI),s=mix(1,.8,x/cfg.frame);
						ctx.clearRect(p[0]-ah,p[1]-ah,a,a);
						ctx.fill(rs(...p,c,s));
						ctx.drawImage(cfg.tex, cfg.c&&i[0]==i[1]*2?0:128*(2-i[0]%2),0,128,128, p[0]-ah*c*s,p[1]-ah*s,a*c*s,a*s);
					}
					return x;
				});
				if(cfg.gflag.some(x=>x))requestAnimationFrame(()=>draw());
			},
			trigger=(n=69,abi=0,t)=>{
				const abs=actx.createBufferSource(),
					s=cfg.abuff[abi].reduce((a,x)=>{const d=Math.abs(n-x[0]);return a[0]<d?a:[d,x];},[Infinity])[1];
				abs.playbackRate.value=Math.pow(2,(n-s[0])/12);abs.buffer=s[1];
				abs.connect(deln);abs.start(t);
			},
			irgen=(fi=.1,d=2.5,cut=10000,ch=2,rate=actx.sampleRate)=>new Promise(f=>{
				const fr=d*rate,
					oac=new(window.OfflineAudioContext||webkitOfflineAudioContext)(ch,fr,rate),
					ab=oac.createBuffer(ch,fr,rate),lpf=oac.createBiquadFilter(),g0=oac.createGain(),
					g1=oac.createGain(),bs=oac.createBufferSource();
				for(let i=0,view;i<ch;i++){view=ab.getChannelData(i);for(let j=0;j<fr;j++)view[j]=Math.random()*2-1;}
				lpf.type='lowpass';lpf.frequency.value=cut;lpf.Q.value=0;
				g0.gain.setTargetAtTime(0,0,d*.2);
				g1.gain.setValueAtTime(0,0);g1.gain.linearRampToValueAtTime(1,fi);g1.gain.setValueAtTime(1,d*.9);g1.gain.linearRampToValueAtTime(0,d);
				bs.buffer=ab;[bs,lpf,g0,g1,oac.destination].reduce((a,x)=>a.connect(x));bs.start();
				oac.startRendering();oac.oncomplete=e=>f(e.renderedBuffer);
			}),
			scale=s=>{
				scd.children[1].setAttribute('style',`--rot:${cfg.sc*30+45}deg;`);
				if(s){const t=actx.currentTime+.05;[72,76,79].forEach((y,i)=>trigger(y+cfg.octave+cfg.sc,0,t+i*.05));}
			},
			reverb=s=>{
				gn0.gain.value=cfg.rev;gn1.gain.value=1-cfg.rev;
				if(s){const t=actx.currentTime+.05;(cfg.scf?[72,74,76,79,84]:[69,81]).forEach((x,i)=>trigger(x+cfg.octave+cfg.sc*cfg.scf,0,t+i*.05));}
			},
			delay=s=>{
				deln.delayTime.value=cfg.del;
				if(s){const t=actx.currentTime+.05,l=actx.outputLatency||0;(cfg.scf?[72,79]:[69,81]).forEach((x,i)=>trigger(x+cfg.octave+cfg.sc*cfg.scf,0,t+(cfg.del+l)*i));}
			},
			stg=()=>{
				//const opt=(x,i)=>`<option value="${i-1}"${i-1==amb?' selected':''}>${x}</option>`;
				alert(`${texts.kbs}
<input type="range" class="style" min="64" max="128" step="4" value="${cfg.kbs}"><hr>${texts.rev}
<input type="range" class="style" min="0" max="1" step="0.0625" value="${cfg.rev}"><hr>${texts.delay}
<input type="range" class="style" min="0" max=".2" step="0.0125" value="${cfg.del}">`);
const sel=albox.querySelector('select'),rng=albox.querySelectorAll('input[type=range]');
				//sel.onchange=()=>{amb=+sel.value;ambset();save();};
				rng[0].oninput =()=>{cfg.kbs=+rng[0].value;cset();save();};
				rng[1].onchange=()=>{cfg.rev=+rng[1].value;reverb(true);save();};
				rng[2].onchange=()=>{cfg.del=+rng[2].value;delay(true);save();};
			},
			load=()=>({instr:menu.instr.value=0,sc:cfg.sc=0,rev:cfg.rev=0,del:cfg.del=.1,kbs:cfg.kbs=88}=JSON.parse(localStorage.instr_stat||'{}')),
			save=()=>localStorage.instr_stat=JSON.stringify({instr:+menu.instr.value,sc:cfg.sc,rev:cfg.rev,del:cfg.del,kbs:cfg.kbs});
			//const fullscr=(x=document.body)=>{x.requestFullscreen=x.requestFullscreen||x.webkitRequestFullscreen;x.requestFullscreen();};
			
		['touchstart','mousedown'].forEach(x=>c.addEventListener(x,fire));
		document.addEventListener('keydown',e=>{
			if(['input','textarea'].some(x=>document.activeElement.matches(x))||e.repeat)return;
			if((e=cfg.k2i[e.code])&&e.every((x,i)=>x<cfg.grid[i]))fire({preventDefault:()=>{},p:e});
		});
		menu.onchange=()=>{set();save();};
		scd.children[0].onclick=()=>{cfg.sc--;scale(true);save();};
		scd.children[1].onclick=()=>{cfg.sc=0;scale(true);save();};
		scd.children[2].onclick=()=>{cfg.sc++;scale(true);save();};
		stgbtn.onclick=stg;
		infobtn.onclick=()=>alert(texts.info);
		alert=x=>{alcb.checked=true;albox.textContent='';albox.insertAdjacentHTML('beforeend',x);};
		alcb.checked=false;
		onresize=cset;

		menu.insertAdjacentHTML('beforeend',d.instr.map((_,i)=>`<label><input type="radio" name="instr" value="${i}" ${[7,18].includes(i)?'disabled':''} ${i==0?'checked':''}><p class="grid tex" style="--bp:${bp(i)};"></p></label>`).join(''));
		deln.connect(revn).connect(gn0).connect(actx.destination);
		deln.connect(gn1).connect(actx.destination);
		irgen().then(x=>revn.buffer=x);
		if(window.MediaRecorder){
			const recn=actx.createMediaStreamDestination(),rec=new MediaRecorder(recn.stream),
				toWav=x=>{//https://github.com/Jam3/audiobuffer-to-wav
					let ch=x.numberOfChannels,rate=x.sampleRate;
					if(ch==1)x=x.getChannelData(0);else{const l=x.getChannelData(0),r=x.getChannelData(1);x=new Float32Array(l.length+r.length);for(let i=0;i<x.length;i++){x[i*2]=l[i];x[i*2+1]=r[i];}};
					const b=new ArrayBuffer(44+x.length*2),v=new DataView(b),str=(c,s)=>{for(let i=0;i<s.length;i++)v.setUint8(c+i,s.charCodeAt(i))};
					str(0,'RIFF');v.setUint32(4,36+x.length*2,true);str(8,'WAVE');
					str(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,ch,true);v.setUint32(24,rate,true);ch*=2;v.setUint32(28,rate*ch,true);v.setUint16(32,ch,true);v.setUint16(34,16,true);
					str(36,'data');v.setUint32(40,x.length*2,true);for(let i=0;i<x.length;i++){const s=Math.max(-1,Math.min(1,x[i]));v.setInt16(44+i*2,s<0?s*0x8000:s*0x7FFF,true);}
					return new Blob([b]);
				};
			rec.ondataavailable=e=>new Response(e.data).arrayBuffer().then(x=>new Promise((f,r)=>actx.decodeAudioData(x,f,r))).then(x=>{
				const a=document.createElement('a');a.download=`sky_instr${new Date().toLocaleString()}.wav`;
				a.href=URL.createObjectURL(toWav(x));a.click();setTimeout(URL.revokeObjectURL,0,a.href);
			}).catch(console.warn);
			gn0.connect(recn);gn1.connect(recn);
			recbtn.onclick=()=>{if(recbtn.classList.toggle('a'))rec.start();else rec.stop();};
			recbtn.classList.remove('d');
		}

		load();set();scale();reverb();delay();
		cfg.tex.onload=()=>{
			const c=document.createElement('canvas');c.width=cfg.tex.naturalWidth;c.height=cfg.tex.naturalHeight;
			c.getContext('2d').drawImage(cfg.tex,0,0);cfg.tex=c;draw(true);
			document.body.insertAdjacentHTML('beforeend',`<style>.grid::before{background-image:url(${c.toDataURL()});}</style>`);
		};
		cfg.tex.src='img/instr.svg';

		//alert('<h1>今日も紅茶さんが可愛いね</h1>');
	</script>
</body>
</html>
