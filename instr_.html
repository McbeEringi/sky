<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>sky_instruments beta</title>
</head>
<body>
	<script src="style.js" async></script>
	<style>
		:root{user-select:none;-webkit-user-select:none;touch-action:manipulation;}
		html,body{height:100%;margin:0;position:relative;overflow:hidden;}
		#c{display:block;margin:0 auto;width:100%;max-height:auto;touch-action:none;}
	</style>
	<canvas id="c"></canvas>build:2201213
	<script>
		'use strict';
		let tex=new Image(),
			k2i=Object.fromEntries(Array.from('QWERTASDFGZXCVB',(x,i)=>[`Key${x}`,i]));
		const ctx=c.getContext('2d'),
			ccfg={
				grid:[5,3],
				gflag:new Array(15).fill(0),
				gsize:88,
				c:true
			},
			csset=()=>{
				Object.assign(c.style,{maxWidth:ccfg.gsize*ccfg.grid[0]+'px',maxHeight:ccfg.gsize*ccfg.grid[1]+'px',marginTop:`min(${ccfg.gsize/2}px,${50/ccfg.grid[0]}%)`});
				c.width=Math.min(document.body.clientWidth,ccfg.gsize*ccfg.grid[0])*devicePixelRatio;ccfg.size=c.width/ccfg.grid[0];c.height=ccfg.size*ccfg.grid[1];
			},
			fire=e=>{
				e.preventDefault();
				const bcr=c.getBoundingClientRect();
				(e.changedTouches?[...e.changedTouches]:[e]).forEach(x=>{
					const p=x.p||[(x.clientX-bcr.x)/bcr.width,(x.clientY-bcr.y)/bcr.height],
						i=Math.floor(p[0]*ccfg.grid[0])+Math.floor(p[1]*ccfg.grid[1])*ccfg.grid[0],
						trg=!ccfg.gflag.some(x=>x);
						ccfg.gflag[i]=24;
					if(trg)draw();
					// ctx.fillStyle='#'+Math.floor(Math.random()*4096).toString('16').padStart(3,'0');
					// ctx.fillRect(p[0]*c.width,p[1]*c.height,4,4);
				});
			},
			draw=()=>{
				ctx.clearRect(0,0,c.width,c.height);
				const mix=(x,y,a)=>x*(1-a)+y*a,
					r=12*devicePixelRatio,a=ccfg.size*.784,ar=a-r-r,
					rs=(x=0,y=0,c=1,s=1)=>{
						const rs=r*s,as=a*s,ars=ar*s,arc=ars*c,rc=rs*c,sign=+(Math.sign(c)<0);
						return new Path2D(`M${x} ${y}m${-arc/2-rc} ${-ars/2}
							v${ ars}a${rc} ${rs} 0 0 ${sign} ${ rc} ${ rs}
							h${ arc}a${rc} ${rs} 0 0 ${sign} ${ rc} ${-rs}
							v${-ars}a${rc} ${rs} 0 0 ${sign} ${-rc} ${-rs}
							h${-arc}a${rc} ${rs} 0 0 ${sign} ${-rc} ${ rs}
						`);
					};
				ctx.fillStyle='#3338';
				ccfg.gflag=ccfg.gflag.map((x,i)=>{
					x=Math.max(x-1,0);
					i=[i%ccfg.grid[0],Math.floor(i/ccfg.grid[0])];
					const p=i.map(y=>(y+.5)*ccfg.size),c=Math.cos(x/12*Math.PI),s=mix(1,.8,x/24);
					ctx.fill(rs(...p,c,s));
					ctx.drawImage(tex,
						ccfg.c&&i[0]==i[1]*2?0:128*(2-i[0]%2),0,128,128,
						p[0]-a/2*c*s,p[1]-a/2*s,a*c*s,a*s);
					return x;
				});
				if(ccfg.gflag.some(x=>x))requestAnimationFrame(draw);
			};
		['touchstart','mousedown'].forEach(x=>c.addEventListener(x,fire));
		onresize=()=>{csset();draw();};

		document.addEventListener('keydown',e=>{
			if(['input','textarea'].some(x=>document.activeElement.matches(x)))return;
			e=k2i[e.code];
			if(e>-1)
				fire({preventDefault:()=>{},p:[e%ccfg.grid[0]/ccfg.grid[0],Math.floor(e/ccfg.grid[0])/ccfg.grid[1]]});
		});


		csset();draw();
		tex.onload=()=>{
			const c=document.createElement('canvas');c.width=tex.naturalWidth;c.height=tex.naturalHeight;
			c.getContext('2d').drawImage(tex,0,0);tex=c;draw();
		};
		tex.src='img/instr.svg';
	</script>
</body>
</html>
